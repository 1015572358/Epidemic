/**
 * 基于bootstrapTreeTable/bootstrap-table-treegrid修改
 * Copyright (c) 2019 ruoyi
 */
!function(a){a.fn.bootstrapTreeTable=function(z,P){var G=a(this).data("bootstrap.tree.table");if(G=G?G:a(this),"string"==typeof z){return a.fn.bootstrapTreeTable.methods[z](G,P)}z=a.extend({},a.fn.bootstrapTreeTable.defaults,z||{}),G.hasSelectItem=!1,G.data_list=null,G.data_obj=null,G.hiddenColumns=[],G.lastAjaxParams,G.isFixWidth=!1;var I=function(){M(),J(),F(),D(),N(),K(!0),G.data("bootstrap.tree.table",G)},M=function(){var c=a("<div class='bootstrap-tree-table'></div>"),b=a("<div class='treetable-table'></div>");G.before(c),c.append(b),b.append(G),G.addClass("table"),z.striped&&G.addClass("table-striped"),z.bordered&&G.addClass("table-bordered"),z.hover&&G.addClass("table-hover"),z.condensed&&G.addClass("table-condensed"),G.html("")},J=function(){var c=a("<div class='treetable-bars'></div>");z.toolbar&&(a(z.toolbar).addClass("tool-left"),c.append(a(z.toolbar)));var b=a('<div class="btn-group tool-right">');if(c.append(b),G.parent().before(c),z.showSearch){var n=a('<button class="btn btn-default btn-outline" type="button" aria-label="search" title="搜索"><i class="glyphicon glyphicon-search"></i></button>');b.append(n),k(n)}if(z.showRefresh){var f=a('<button class="btn btn-default btn-outline" type="button" aria-label="refresh" title="刷新"><i class="glyphicon glyphicon-repeat"></i></button>');b.append(f),B(f)}if(z.showColumns){var h=a('<div class="btn-group pull-right" title="列"><button type="button" aria-label="columns" class="btn btn-default btn-outline dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="glyphicon glyphicon-list"></i> <span class="caret"></span></button></div>'),m=a('<ul class="dropdown-menu columns" role="menu"></ul>');a.each(z.columns,function(o,i){if("selectItem"!=i.field){var d=null;void 0===i.visible||1==i.visible?d=a('<li role="menuitem"><label><input type="checkbox" checked="checked" data-field="'+i.field+'" value="'+i.field+'" > '+i.title+"</label></li>"):(d=a('<li role="menuitem"><label><input type="checkbox" data-field="'+i.field+'" value="'+i.field+'" > '+i.title+"</label></li>"),G.hiddenColumns.push(i.field)),m.append(d)}}),h.append(m),b.append(h),g()}else{a.each(z.columns,function(i,d){"selectItem"!=d.field&&void 0!==d.visible&&1!=d.visible&&G.hiddenColumns.push(d.field)})}},A=function(){a.each(G.hiddenColumns,function(c,b){G.find("."+b+"_cls").hide()})},F=function(){var c=a("<tr></tr>");a.each(z.columns,function(h,f){var i=null;0==h&&"selectItem"==f.field?(G.hasSelectItem=!0,i=a('<th style="width:36px"></th>')):i=a('<th style="'+(f.width?"width:"+f.width+(f.widthUnit?f.widthUnit:"px"):"")+'" class="'+f.field+'_cls"></th>'),!G.isFixWidth&&f.width&&(G.isFixWidth=f.width.indexOf("px")>-1?!0:!1),i.html(f.title),c.append(i)});var b=a('<thead class="treetable-thead"></thead>');b.append(c),G.append(b)},D=function(){var b=a('<tbody class="treetable-tbody"></tbody>');G.append(b),z.height&&b.css("height",z.height)},N=function(c){G.data_list={},G.data_obj={};var b=G.find("tbody"),f='<tr><td colspan="'+z.columns.length+'"><div style="display: block;text-align: center;">正在努力地加载数据中，请稍候……</div></td></tr>';b.html(f),z.url?a.ajax({type:z.type,url:z.url,data:c?c:z.ajaxParams,dataType:"JSON",success:function(h,d,i){h=e(z,z.responseHandler,[h],h),E(h),e(z,z.onLoadSuccess,[h],h)},error:function(h,d){var i='<tr><td colspan="'+z.columns.length+'"><div style="display: block;text-align: center;">'+h.responseText+"</div></td></tr>";b.html(i)}}):E(z.data)},E=function(f){var b=G.find("tbody");if(b.html(""),!f||f.length<=0){var t='<tr><td colspan="'+z.columns.length+'"><div style="display: block;text-align: center;">没有找到匹配的记录</div></td></tr>';return void b.html(t)}L(f);var h=G.data_list._root_;h&&a.each(h,function(i,d){var c="row_id_"+i;q(d,1,c,"row_root")}),a.each(f,function(i,d){if(!d.isShow){var c=O(d,!1,1,"","");b.append(c)}}),G.append(b),Q(),H(),A(),K();var s=a(G).parent(".treetable-table"),m=s.outerWidth();if(a.common.isMobile()||769>m){var u="width: "+m+"px;overflow: auto;position: relative;";s.attr("style",u);var n=0;a.each(z.columns,function(d,c){n+=0==d&&"selectItem"==c.field?36:200}),a(G).attr("style","width:"+n+"px")}},K=function(c){if(z.height>0){var b=G.find("thead"),m=G.find("tbody"),f=parseInt(G.css("border-left-width"))+parseInt(G.css("border-right-width"));if(b.css("width",m.children(":first").width()),c){var h=!1;a(window).resize(function(){h||(h=!0,setTimeout(function(){G.isFixWidth||m.css("width",G.parent().width()-f),b.css("width",m.children(":first").width()),h=!1},300))})}}},L=function(c){var b=z.rootIdValue?z.rootIdValue:null,h=[],f=!1;a.each(c,function(d,i){-1==a.inArray(i[z.parentCode],h)&&h.push(i[z.parentCode])}),a.each(c,function(d,i){i.isShow=!1;var l="0"==i[z.parentCode]||0==i[z.parentCode]||null==i[z.parentCode]||""==i[z.parentCode]||a.inArray(i[z.code],h)>0&&!f;!i[z.parentCode]||(b?i[z.parentCode]==z.rootIdValue:l)?(f=!0,G.data_list._root_||(G.data_list._root_=[]),G.data_obj["id_"+i[z.code]]||G.data_list._root_.push(i)):(G.data_list["_n_"+i[z.parentCode]]||(G.data_list["_n_"+i[z.parentCode]]=[]),G.data_obj["id_"+i[z.code]]||G.data_list["_n_"+i[z.parentCode]].push(i)),G.data_obj["id_"+i[z.code]]=i})},q=function(c,b,p,f){var h=G.find("tbody"),n=G.data_list["_n_"+c[z.code]],m=O(c,n?!0:!1,b,p,f);h.append(m),n&&a.each(n,function(l,i){var d=p+"_"+l;q(i,b+1,d,p)})},O=function(c,b,p,f,h){c.isShow=!0,c.row_id=f,c.p_id=h,c.lv=p;var n=a('<tr id="'+f+'" pid="'+h+'"></tr>'),m=z.expanderCollapsedClass;return z.expandAll?(n.css("display","table"),m=z.expanderExpandedClass):1==p?(n.css("display","table"),m=z.expandFirst?z.expanderExpandedClass:z.expanderCollapsedClass):2==p?(z.expandFirst?n.css("display","table"):n.css("display","none"),m=z.expanderCollapsedClass):(n.css("display","none"),m=z.expanderCollapsedClass),a.each(z.columns,function(d,o){if("selectItem"==o.field){G.hasSelectItem=!0;var t=a('<td style="text-align:center;width:36px"></td>');if(o.radio){var r=a('<input name="select_item" type="radio" value="'+c[z.code]+'"></input>');t.append(r)}if(o.checkbox){var r=a('<input name="select_item" type="checkbox" value="'+c[z.code]+'"></input>');t.append(r)}n.append(t)}else{var t=a('<td name="'+o.field+'" class="'+o.field+'_cls"></td>');if(o.width&&t.css("width",o.width+(o.widthUnit?o.widthUnit:"px")),o.align&&t.css("text-align",o.align),z.expandColumn==d&&t.css("text-align","left"),o.valign&&t.css("vertical-align",o.valign),z.showTitle&&t.addClass("ellipsis"),o.formatter?t.html(o.formatter.call(this,j(c,o.field),c,d)):(z.showTitle&&t.attr("title",c[o.field]),t.text(j(c,o.field))),z.expandColumn==d){b?t.prepend('<span class="treetable-expander '+m+'"></span>'):t.prepend('<span class="treetable-expander"></span>');for(var l=0;p-1>l;l++){t.prepend('<span class="treetable-indent"></span>')}}n.append(t)}}),n},k=function(b){a(b).off("click").on("click",function(){a(".search-collapse").slideToggle()})},B=function(b){a(b).off("click").on("click",function(){G.refresh()})},g=function(){a(".bootstrap-tree-table .treetable-bars .columns label input").off("click").on("click",function(){var b=a(this);b.prop("checked")?G.showColumn(a(this).val()):G.hideColumn(a(this).val())})},H=function(){G.find("tbody").find("tr").unbind(),G.find("tbody").find("tr").click(function(){if(G.hasSelectItem){var b=a(this).find("input[name='select_item']");"radio"==b.attr("type")?(b.prop("checked",!0),G.find("tbody").find("tr").removeClass("treetable-selected"),a(this).addClass("treetable-selected")):"checkbox"==b.attr("type")?b.prop("checked")?(b.prop("checked",!0),G.find("tbody").find("tr").removeClass("treetable-selected"),a(this).addClass("treetable-selected")):(b.prop("checked",!1),G.find("tbody").find("tr").removeClass("treetable-selected")):b.prop("checked")?(b.prop("checked",!1),a(this).removeClass("treetable-selected")):(b.prop("checked",!0),a(this).addClass("treetable-selected"))}})},Q=function(){G.find("tbody").find("tr").find(".treetable-expander").unbind(),G.find("tbody").find("tr").find(".treetable-expander").click(function(){var c=a(this).hasClass(z.expanderExpandedClass),b=a(this).hasClass(z.expanderCollapsedClass);if(c||b){var m=a(this).parent().parent(),f=m.attr("id"),h=G.find("tbody").find("tr[id^='"+f+"_']");c?(a(this).removeClass(z.expanderExpandedClass),a(this).addClass(z.expanderCollapsedClass),h&&h.length>0&&a.each(h,function(i,d){a(d).css("display","none")})):(a(this).removeClass(z.expanderCollapsedClass),a(this).addClass(z.expanderExpandedClass),h&&h.length>0&&a.each(h,function(i,o){var d=a("#"+a(o).attr("pid")).children().eq(z.expandColumn).find(".treetable-expander");d.hasClass(z.expanderExpandedClass)&&a(o).css("display","table")}))}})};G.refresh=function(b){b&&(G.lastAjaxParams=b),N(G.lastAjaxParams)},G.appendData=function(b){a.each(b,function(X,R){var U,S=G.data_obj["id_"+R[z.code]],ab=G.data_obj["id_"+R[z.parentCode]],w=G.data_list["_n_"+R[z.parentCode]],f="",V="",t=1;if(S&&S.row_id&&""!=S.row_id&&(f=S.row_id),ab){if(V=ab.row_id,""==f){var T=0;w&&w.length>0&&(T=w.length),f=ab.row_id+"_"+T}t=ab.lv+1,U=O(R,!1,t,f,V);var aa=a("#"+ab.row_id).children().eq(z.expandColumn).find(".treetable-expander"),Z=aa.hasClass(z.expanderExpandedClass),n=aa.hasClass(z.expanderCollapsedClass);if(Z||n?Z&&U.css("display","table"):aa.addClass(z.expanderCollapsedClass),S){a("#"+S.row_id).before(U),a("#"+S.row_id).remove()}else{var W=ab.row_id.split("_"),y=ab.row_id.substring(0,ab.row_id.length-1)+(parseInt(W[W.length-1])+1);a("#"+y).before(U)}}else{if(U=O(R,!1,t,f,V),S){a("#"+S.row_id).before(U),a("#"+S.row_id).remove()}else{var Y=G.find("tbody");Y.append(U)}}R.isShow=!0,L([R])}),Q(),H(),A()},G.toggleRow=function(d){var c=G.data_obj["id_"+d],b=a("#"+c.row_id).find(".treetable-expander");b.trigger("click")},G.expandRow=function(f){var c=G.data_obj["id_"+f],b=a("#"+c.row_id).find(".treetable-expander"),h=b.hasClass(G.options.expanderCollapsedClass);h&&b.trigger("click")},G.collapseRow=function(f){var c=G.data_obj["id_"+f],b=a("#"+c.row_id).find(".treetable-expander"),h=b.hasClass(G.options.expanderExpandedClass);h&&b.trigger("click")},G.expandAll=function(){G.find("tbody").find("tr").find(".treetable-expander").each(function(c,d){var b=a(d).hasClass(z.expanderCollapsedClass);b&&a(d).trigger("click")})},G.collapseAll=function(){G.find("tbody").find("tr").find(".treetable-expander").each(function(c,d){var b=a(d).hasClass(z.expanderExpandedClass);b&&a(d).trigger("click")})},G.showColumn=function(c,b){var h=a.inArray(c,G.hiddenColumns);if(h>-1&&G.hiddenColumns.splice(h,1),G.find("."+c+"_cls").show(),b&&z.showColumns){var f=a(".bootstrap-tree-table .treetable-bars .columns label").find("input[value='"+c+"']");f.prop("checked","checked")}},G.hideColumn=function(c,b){if(G.hiddenColumns.push(c),G.find("."+c+"_cls").hide(),b&&z.showColumns){var f=a(".bootstrap-tree-table .treetable-bars .columns label").find("input[value='"+c+"']");f.prop("checked","")}};var j=function(f,d){var c=f;if("string"!=typeof d||f.hasOwnProperty(d)){return f[d]}var h=d.split(".");for(var b in h){c=c&&c[h[b]]}return c},e=function(h,c,o,b){var m=c;if("string"==typeof c){var f=c.split(".");f.length>1?(m=window,a.each(f,function(i,d){m=m[d]})):m=window[c]}return"object"==typeof m?m:"function"==typeof m?m.apply(h,o):!m&&"string"==typeof c&&sprintf.apply(this,[c].concat(o))?sprintf.apply(this,[c].concat(o)):b};return I(),G},a.fn.bootstrapTreeTable.methods={getSelections:function(e,c){var g=e.find("tbody").find("tr").find("input[name='select_item']:checked"),b=[];if("radio"==g.attr("type")){var f=e.data_obj["id_"+g.val()];b.push(f)}else{g.each(function(h,j){var i=e.data_obj["id_"+a(j).val()];b.push(i)})}return b},refresh:function(c,b){b?c.refresh(b):c.refresh()},appendData:function(c,b){b&&c.appendData(b)},toggleRow:function(c,b){c.toggleRow(b)},expandRow:function(c,b){c.expandRow(b)},collapseRow:function(c,b){c.collapseRow(b)},expandAll:function(b){b.expandAll()},collapseAll:function(b){b.collapseAll()},showColumn:function(c,b){c.showColumn(b,!0)},hideColumn:function(c,b){c.hideColumn(b,!0)}},a.fn.bootstrapTreeTable.defaults={code:"code",parentCode:"parentCode",rootIdValue:null,data:null,type:"GET",url:null,ajaxParams:{},expandColumn:0,expandAll:!1,expandFirst:!0,striped:!1,bordered:!0,hover:!0,condensed:!1,columns:[],toolbar:null,height:0,showTitle:!0,showSearch:!0,showColumns:!0,showRefresh:!0,expanderExpandedClass:"glyphicon glyphicon-chevron-down",expanderCollapsedClass:"glyphicon glyphicon-chevron-right",responseHandler:function(b){return !1},onLoadSuccess:function(b){return !1}}}(jQuery);